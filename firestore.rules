rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function hasEduEmail() {
      return request.auth.token.email.matches('.*\\.edu$');
    }

    // Users collection
    match /users/{userId} {
      // Anyone can read user profiles (for feed display)
      allow read: if true;

      // Users can only create/update their own profile
      allow create: if isAuthenticated() && isOwner(userId);
      allow update: if isAuthenticated() && isOwner(userId);

      // Only the user can delete their profile
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // Posts collection
    match /posts/{postId} {
      // Anyone can read public posts
      allow read: if resource.data.isPublic == true ||
                    (isAuthenticated() && resource.data.userId == request.auth.uid);

      // Authenticated users can create posts
      allow create: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid;

      // Users can update their own posts
      allow update: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;

      // Users can delete their own posts
      allow delete: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
    }

    // Communities collection
    match /communities/{communityId} {
      allow read: if true;
      // Only authenticated users can create communities
      allow create: if isAuthenticated() &&
                      request.resource.data.createdBy == request.auth.uid;
      // Only the creator can update their community
      allow update: if isAuthenticated() &&
                      resource.data.createdBy == request.auth.uid;
      allow delete: if false; // Admin only via Admin SDK
    }

    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() &&
                    resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
    }

    // Venues collection (restaurants)
    match /venues/{venueId} {
      allow read: if true;
      // Only authenticated .edu users can create venues
      allow create: if isAuthenticated() && hasEduEmail();
      // Only the creator can update venues they created
      allow update: if isAuthenticated() &&
                      resource.data.createdBy == request.auth.uid;
      allow delete: if false; // Admin only
    }

    // Fridges collection - supports owner and members
    match /fridges/{fridgeId} {
      // Allow read if user is owner OR a member of the fridge
      allow read: if isAuthenticated() && (
                    resource.data.ownerId == request.auth.uid ||
                    exists(/databases/$(database)/documents/fridges/$(fridgeId)/members/$(request.auth.uid))
                  );
      // Only owner can create/update/delete the fridge itself
      allow create: if isAuthenticated() &&
                      request.resource.data.ownerId == request.auth.uid;
      allow update: if isAuthenticated() &&
                      resource.data.ownerId == request.auth.uid;
      allow delete: if isAuthenticated() &&
                      resource.data.ownerId == request.auth.uid;

      // Fridge members subcollection
      match /members/{memberId} {
        allow read: if isAuthenticated();
        // Only fridge owner can manage members
        allow write: if isAuthenticated() &&
                      get(/databases/$(database)/documents/fridges/$(fridgeId)).data.ownerId == request.auth.uid;
      }

      // Fridge items subcollection - owners and members can read/write
      match /items/{itemId} {
        allow read: if isAuthenticated() && (
                      get(/databases/$(database)/documents/fridges/$(fridgeId)).data.ownerId == request.auth.uid ||
                      exists(/databases/$(database)/documents/fridges/$(fridgeId)/members/$(request.auth.uid))
                    );
        allow write: if isAuthenticated() && (
                       get(/databases/$(database)/documents/fridges/$(fridgeId)).data.ownerId == request.auth.uid ||
                       exists(/databases/$(database)/documents/fridges/$(fridgeId)/members/$(request.auth.uid))
                     );
      }
    }

    // Recipes collection
    match /recipes/{recipeId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
    }

    // Live events collection
    match /live_events/{eventId} {
      allow read: if true;
      // Only the creator can create/update their events
      allow create: if isAuthenticated() &&
                      request.resource.data.creatorId == request.auth.uid;
      allow update: if isAuthenticated() &&
                      resource.data.creatorId == request.auth.uid;
      allow delete: if false; // Admin only
    }

    // Grocery hauls collection
    match /groceryHauls/{haulId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
    }
  }
}
